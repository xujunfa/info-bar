# 决策日志

## [DEC-001] 首期采用方式 A（MAIN world 注入 + fetch/xhr hook）

- **日期**：2026-03-01
- **里程碑**：1 — Extension 采集链路（方式 A）
- **背景**：需要在 provider API 不稳定或鉴权复杂时，快速建立可运行的数据采集链路。
- **备选方案**：
  1. 方式 A：MAIN world 注入 + fetch/xhr hook — 实现快、侵入低、可快速验证；但受页面实现细节变化影响。
  2. 方式 B：`chrome.debugger + CDP` — 捕获能力更底层；但权限敏感、复杂度高、首期成本大。
- **决策**：首期落地方式 A，方式 B 作为后续备选。
- **理由**：当前目标是尽快打通端到端链路并验证业务可行性，方式 A 更符合交付速度与风险平衡。

## [DEC-002] 采用统一 Envelope + 去重 + 双存储（local + Supabase）

- **日期**：2026-03-01
- **里程碑**：2 — 标准化、持久化与 Supabase 集成
- **背景**：采集数据需要兼顾本地调试可见性、跨端消费一致性以及重复事件控制。
- **备选方案**：
  1. 只写本地 `chrome.storage.local` — 调试方便，但跨端读取困难、无法作为长期数据源。
  2. 只写远端 Supabase — 结构统一，但离线调试与故障定位能力不足。
  3. 本地+远端双通道，统一契约并去重 — 实现稍复杂，但可同时满足调试与生产链路。
- **决策**：采用统一 Envelope，先本地去重落盘，再写 Supabase，并保留 read-back 缓存。
- **理由**：最大化可观测性与稳定性，且为 Mac App 消费提供统一来源。

## [DEC-003] Mac App 的 factory provider 改为读取 Supabase connector_events

- **日期**：2026-03-01
- **里程碑**：2 — 标准化、持久化与 Supabase 集成
- **背景**：Factory 原始 API 的鉴权链路复杂且易受前端变化影响，维护成本高。
- **备选方案**：
  1. 继续直接调用 Factory API — 依赖 provider 鉴权细节，波动风险大。
  2. 读取扩展产出的 Supabase 标准化事件 — 链路更统一，但需要维护映射逻辑。
- **决策**：Factory 在 Mac App 侧使用 `SupabaseConnectorEventClient` 读取标准化事件。
- **理由**：降低 provider-specific 鉴权依赖，统一多 provider 接入路径。

## [DEC-004] 配置管理采用 `config.example.json` + `config.local.json`

- **日期**：2026-03-01
- **里程碑**：2 — 标准化、持久化与 Supabase 集成
- **背景**：需要在仓库可共享默认配置与本地私密配置之间取得平衡。
- **备选方案**：
  1. 全部配置入库 — 协作方便，但存在敏感信息泄露风险。
  2. 全部依赖环境变量 — 安全性高，但开发体验较差，跨模块一致性弱。
  3. 示例配置入库 + 本地配置忽略 — 兼顾安全与可用性。
- **决策**：仓库保留 `config.example.json`，真实配置写入 `config.local.json` 并 gitignore。
- **理由**：降低泄露风险并提升多端（Mac App + Extension）配置一致性。

## [DEC-005] 设置页视觉规范采用集中 Theme Token（里程碑 1）

- **日期**：2026-03-02
- **里程碑**：1 — 设置页视觉系统升级
- **背景**：设置页需要统一更新 Panel、列表行、空状态等多个区域的视觉表现，若样式分散在各视图中，后续迭代成本高且容易失配。
- **备选方案**：
  1. 保持样式内联在 `SettingsWindowController.swift` — 改动快，但颜色/间距/字体难统一，回归风险高。
  2. 新增集中式 `SettingsTheme` Token 层并在设置页统一消费 — 初次改造成本更高，但可维护性和一致性更好。
- **决策**：采用 `SettingsTheme.swift` 统一承载设置页 Token，并让窗口/列表/详情空态共用。
- **理由**：为里程碑 2-4 的信息密度升级提供稳定视觉底座，减少重复样式定义和局部回归。

## [DEC-006] 设置页视觉回归“原生优先”策略（里程碑 1 收口）

- **日期**：2026-03-02
- **里程碑**：1 — 设置页视觉系统升级（用户反馈修正）
- **背景**：首版视觉改造引入较多自定义材质与装饰，实际效果偏“塑料感”，与 macOS 原生风格不一致。
- **备选方案**：
  1. 继续增强自定义视觉层（更强渐变/阴影/边框）— 风格冲突风险高，迭代成本大。
  2. 收敛到原生组件观感（默认窗口容器 + 轻分割线 + 轻量交互态）— 视觉冲突更少，一致性更高。
- **决策**：采用原生优先策略，移除额外容器装饰与重交互样式，保留必要层次反馈。
- **理由**：优先保证可读性与平台一致性，降低后续功能迭代中的视觉维护成本。

## [DEC-007] Usage 扩展字段采用“强兼容+弱约束”清洗策略

- **日期**：2026-03-02
- **里程碑**：2 — Usage 信息模型扩展
- **背景**：`QuotaWindow` 新增 `used/limit/remaining/unit/windowTitle/metadata` 后，需要兼容现有只传 `usedPercent` 的调用方，同时避免异常输入污染 UI。
- **备选方案**：
  1. 严格校验并在异常时抛错 — 数据质量高，但容易中断刷新链路。
  2. 仅原样透传新字段 — 兼容性高，但负值/空串/超限会进入展示层，文案不稳定。
  3. 初始化时做温和清洗并保留原有百分比路径 — 兼顾兼容性与稳定性。
- **决策**：采用初始化清洗策略：`used/remaining` 非负化、`limit` 仅保留正值、`used` 按 `limit` 上限裁剪、`remaining` 可从 `limit-used` 推导，文本字段去空白，metadata 过滤空键值。
- **理由**：不破坏历史调用路径，且让设置页在字段缺失/脏数据下仍输出稳定文案。

## [DEC-008] Provider Usage 映射采用“可推导优先、缺字段降级”策略

- **日期**：2026-03-02
- **里程碑**：3 — Provider Usage 映射增强
- **背景**：各 Provider 返回结构和字段语义不一致，且存在字段缺失、字符串数字、秒/毫秒时间戳混用等情况。
- **备选方案**：
  1. 严格按固定 schema 映射，字段缺失即失败 — 一致性高，但刷新链路容易被单字段异常阻断。
  2. 宽松透传原始字段，不做统一推导 — 落地快，但设置页展示会出现信息断裂和格式不稳。
  3. 统一“显式字段优先 + 可推导补齐 + 最后降级”映射策略 — 实现复杂度适中，稳定性更好。
- **决策**：采用方案 3。为 `Codex/MiniMax/BigModel/ZenMux/Factory` 统一补齐 `used/limit/remaining/unit/windowTitle/metadata`，并在缺字段时按可推导规则回退；仅在关键窗口无法推导 `usedPercent` 时报错。
- **理由**：保证刷新链路稳定，最大化利用 provider 已有数据，同时让设置页展示层拿到统一且尽可能完整的 usage 信息。

## [DEC-009] 设置页展示层采用“ViewModel 聚合 + 元数据优先级”策略

- **日期**：2026-03-02
- **里程碑**：4 — 设置页信息呈现重构
- **背景**：里程碑 4 需要同时升级右侧详情区和左侧列表摘要，若在视图层直接解析窗口字段/metadata，会导致文案规则分散、测试脆弱。
- **备选方案**：
  1. 在 `SettingsWindowController` 内直接拼装所有展示文案 — 改动集中但会让 UI 层承担数据清洗逻辑，难以单测和复用。
  2. 在 `SettingsProviderViewModel` 预聚合状态、摘要、window 指标与 metadata 展示字段，再由视图消费 — 需要扩展 ViewModel，但分层清晰、易测。
- **决策**：采用方案 2，并约定 window metadata 按 `Model/Plan/Window/Source` 等优先级挑选最多 3 项展示，避免信息噪声。
- **理由**：让列表与详情共享同一数据解释规则，降低切换错位/文案不一致风险，同时为后续 provider 字段扩展保留稳定适配层。

## [DEC-010] 设置页信息降噪：列表只看更新时间，详情聚焦用量与时间

- **日期**：2026-03-02
- **里程碑**：5 — 回归验证与文档沉淀（用户反馈修正）
- **背景**：用户反馈设置页出现信息过载：左侧展示 `Visible` 与用量摘要噪声较大，右侧重复状态标签、底部开关与 metadata（trace/source/key）影响可读性。
- **备选方案**：
  1. 保留当前全量字段展示，通过样式弱化次要信息 — 改动小，但视觉复杂度和认知负担仍高。
  2. 回归“关键路径优先”：左侧仅显示 provider + 更新时间，右上保留开关与刷新，usage 卡片仅展示用量与 reset 时间。
- **决策**：采用方案 2，并为刷新按钮增加短暂禁用/高亮反馈，提升交互可感知性。
- **理由**：优先满足高频决策信息（用了多少、何时重置、是否显示），减少噪声字段干扰，符合设置页“快速判断与操作”的使用目标。

## [DEC-011] Usage 详情采用“可读性优先”的精确时间与按值渲染策略

- **日期**：2026-03-02
- **里程碑**：5 — 回归验证与文档沉淀（用户反馈修正）
- **背景**：用户希望 reset 时间更具体、避免 `-` 占位噪声、并补充 token 消耗信息（M 单位）与账号标识信息。
- **备选方案**：
  1. 保持 `resets in X` 与固定三栏指标（缺失时显示 `-`）— 实现简单，但可读性和信息密度不理想。
  2. 改为精确 reset 时间（含相对剩余）、按值渲染指标、tokens 增补 `M` 维度、顶部显示 account（若可提取）— 实现复杂度略增，但信息更贴近用户决策需求。
- **决策**：采用方案 2。reset 文案统一为 `resets at MM-dd HH:mm (in X)`；指标缺失时直接隐藏；tokens 额外展示 `TOKENS (M)`；从 window metadata 提取邮箱/手机号等 account 信息并展示在 `ID` 同行。
- **理由**：在不增加交互复杂度的前提下显著提升设置页可读性，减少噪声字段和占位文本带来的视觉负担。

## [DEC-012] 设置页交互一致性：窗口命名规范 + 非空选择约束 + Refresh 显式加载态

- **日期**：2026-03-02
- **里程碑**：5 — 回归验证与文档沉淀（用户反馈修正）
- **背景**：用户反馈仍存在可读性和交互一致性问题：5h/周窗口命名混杂（`W`/`Current interval`）、左侧条目拥挤且缺状态点、Refresh 与 toggle 风格不协调且缺显式 loading、空白点击会清空选中并出现空白详情。
- **备选方案**：
  1. 保持现状，只微调样式常量和文案 — 实现快，但关键交互问题（加载态、空白取消选中）仍会反复出现。
  2. 增加明确约束：窗口命名标准化、列表非空选择策略、Refresh spinner 加载态、左侧密度和状态表达同步升级。
- **决策**：采用方案 2。统一窗口命名为 `5-hour usage`/`Weekly usage`；列表行高提升并恢复可见性小圆点；Refresh 按钮改为紧凑样式并在点击时切换 spinner；列表启用“非空时不允许无选中”策略。
- **理由**：同时解决“信息一致性”和“操作稳定性”两个高频痛点，避免用户在查看/刷新/切换时出现认知跳变或误操作。
